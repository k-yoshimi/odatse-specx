# optimize_composition.py Parameter Manual

NAME
    optimize_composition.py - High-entropy alloy composition optimization tool using AkaiKKR

SYNOPSIS
    python optimize_composition.py <config_file> [--mock-output PATH]

DESCRIPTION
    `optimize_composition.py` combines ODAT-SE's search algorithms with AkaiKKR calculations
    to automatically explore high-entropy alloy (HEA) compositions. Each candidate composition
    is converted to an AkaiKKR input file, calculations are executed, and the objective metric
    (usually total energy) is extracted from the output file and returned to ODAT-SE.

    Configuration is specified in a TOML format file. It consists of the following sections:

    - [base]          ODAT-SE basic settings
    - [algorithm]     Search algorithm settings
    - [algorithm.param] Algorithm parameters
    - [solver]       Solver settings
    - [runner]       Runner settings
    - [hea]          Main HEA optimization settings
    - [hea.metric]   Metric extraction settings
    - [[hea.species]] Atom species definitions (array)

CONFIGURATION SECTIONS

[base]
    Basic settings section. Specifies ODAT-SE basic parameters.

    dimension (integer, required)
        Dimension of the search space. When simplex_mode is enabled, set to number of
        species - 1.
        Example: For 4-element alloy with simplex_mode=true, dimension=3

    root_dir (string, optional, default: ".")
        Root path of the working directory. Relative paths are resolved relative to this
        directory.

    output_dir (string, optional, default: "odatse/output")
        ODAT-SE output directory.

[algorithm]
    Search algorithm settings section.

    name (string, required)
        Algorithm name to use. Example: "mapper", etc.

    seed (integer, optional)
        Random seed. Specify for reproducible results.

    colormap (string, optional)
        Path to colormap file.

[algorithm.param]
    Algorithm-specific parameters section.

    min_list (array of floats, required)
        List of lower bounds for each dimension. Length must match dimension.
        Example: [0.0, 0.0, 0.0]

    max_list (array of floats, required)
        List of upper bounds for each dimension. Length must match dimension.
        Example: [1.0, 1.0, 1.0]

    num_list (array of integers, required)
        Number of grid points per dimension (for mapper algorithm).
        Example: [5, 5, 5]

[solver]
    Solver settings section.

    name (string, required)
        Solver name. Specify "function".

[runner]
    Runner settings section.

    [runner.log]
        Log settings subsection.

        interval (integer, optional, default: 10)
            Log output interval (number of trials).

[hea]
    Main HEA optimization settings section. This section is required.

    template_input (string, required)
        Template path of AkaiKKR input file. This file is loaded and the specified atom
        species label is replaced with a mixed atom species.

    target_label (string, required)
        Atom species label to replace. Atoms with this label are replaced with a mixed
        atom species. Example: "Y_1h_2"

    new_label (string, optional, default: "{target_label}_mix")
        Label name of the newly created mixed atom species. Example: "Ln_HEA"

    work_dir (string, optional, default: "runs")
        Base path of working directory for each trial. Each trial is created at
        {work_dir}/trial_{trial_number:05d}.

    output_file (string, optional, default: "test.out")
        Output filename generated by AkaiKKR. Metrics are extracted from this file.

    akai_command (array of strings or string, required)
        Command to execute AkaiKKR. Can be specified as array or string format.
        The following placeholders are available:
        - {input}     Input filename only (e.g., "test.in")
        - {input_path} Full path to input file

        Examples:
          akai_command = ["akaiKKR", "{input}"]
          akai_command = ["/usr/local/bin/akaiKKR", "-option", "{input_path}"]

    keep_intermediate (boolean, optional, default: false)
        If set to true, working directories for each trial are preserved.
        If false, directories for successful trials are deleted.
        Even when errors occur, files are preserved/deleted according to this setting.

    mock_output (string, optional)
        Mock output file path for testing. If specified, this file is copied and used
        without running AkaiKKR. Do not set this for actual calculations.
        For temporary testing, it is recommended to override via CLI --mock-output
        without modifying the TOML.

    simplex_mode (boolean, optional, default: false)
        If set to true, uses stick-breaking transformation to always generate compositions
        that sum to 1.0. In this case, base.dimension must be set to number of species - 1.

    error_penalty (float, optional, default: 1.0e10)
        Penalty value returned when calculation fails. Used to make the optimization
        algorithm avoid failed composition points.

    error_log (string, optional)
        Path to error log file. If specified, detailed information about failed trials
        is recorded. The log includes:
        - Error type and message
        - Trial number and composition parameters
        - Paths to input file, output file, and trial directory

    timeout_sec (integer, optional)
        Timeout time (seconds) for AkaiKKR execution. If not specified, no timeout
        is applied.

    env (dictionary, optional)
        Dictionary of environment variables to set when executing AkaiKKR. Example:
          env = { "OMP_NUM_THREADS" = "4" }

    rmt (float, optional)
        MT radius of mixed atom species. If not specified, the rmt value of the
        target_label atom species is used.

    field (float, optional)
        Magnetic field of mixed atom species. If not specified, the field value of
        the target_label atom species is used.

    mxl (integer, optional)
        Maximum angular momentum of mixed atom species. If not specified, the mxl
        value of the target_label atom species is used.

[hea.metric]
    Metric extraction settings section. Specifies how to extract the objective metric
    from AkaiKKR output files.

    name (string, optional, default: "total_energy")
        Metric name. The following built-in patterns are available:
        - "total_energy"  Extract total energy (default)
        - "band_energy"   Extract band energy

        If using a custom metric, also specify pattern.

    pattern (string, optional)
        Regular expression pattern to extract the metric. Specify when the built-in
        pattern specified by name cannot be used, or when using a custom pattern.

        Example:
          pattern = "sigma=\\s*([-.0-9Ee]+)"  # Extract conductivity

    group (integer, optional, default: 1)
        Capture group number in the regular expression. Specify the group containing
        the numeric value to extract.

    scale (float, optional, default: 1.0)
        Scalar value to multiply the extracted value. Used for unit conversion or
        sign inversion.

    transform (string, optional, default: "identity")
        Transformation to apply to the extracted value. Available: identity / abs / log / log1p / sqrt / square.
        Example: To smooth total energy, use `transform = "log1p"`.
        To add custom transformations, add one line like `"cube": lambda x: x ** 3`
        to `MetricExtractor._TRANSFORMS` in `optimize_composition.py`, then specify
        `transform = "cube"` in TOML.

    ignore_case (boolean, optional, default: true)
        If true, performs case-insensitive search.

[[hea.species]]
    Array section for atom species definitions. Defines each atom species to mix. At least one
    entry is required, and at least two entries are required when simplex_mode is enabled.

    label (string, required)
        Label name of the atom species. Example: "Y", "La", "Nd"

    atomic_number (integer, required)
        Atomic number. Example: 39 (Y), 57 (La), 60 (Nd)

    symbol (string, optional)
        Alternative specification for label. Used when label is not specified.

EXAMPLES

Basic 4-element alloy composition exploration:

    [base]
    dimension = 3
    root_dir = "."
    output_dir = "odatse/output"

    [algorithm]
    name = "mapper"
    seed = 20240502

    [algorithm.param]
    min_list = [0.0, 0.0, 0.0]
    max_list = [1.0, 1.0, 1.0]
    num_list = [5, 5, 5]

    [solver]
    name = "function"

    [runner]
    [runner.log]
    interval = 10

    [hea]
    template_input = "test/refs/test.in"
    target_label = "Y_1h_2"
    new_label = "Ln_HEA"
    work_dir = "runs/hea_trials"
    output_file = "test.out"
    akai_command = ["akaiKKR", "<", "{input}", ">", "{output}"]
    keep_intermediate = false
    simplex_mode = true
    error_penalty = 1.0e10
    error_log = "runs/error_log.txt"

    [hea.metric]
    name = "total_energy"

    [[hea.species]]
    label = "Y"
    atomic_number = 39

    [[hea.species]]
    label = "La"
    atomic_number = 57

    [[hea.species]]
    label = "Nd"
    atomic_number = 60

    [[hea.species]]
    label = "Sm"
    atomic_number = 62

Example of minimizing a custom metric (conductivity):

    [hea.metric]
    name = "conductivity"
    pattern = "sigma=\\s*([-.0-9Ee]+)"
    scale = 1.0
    ignore_case = true
    group = 1

Example of executing AkaiKKR with environment variables set:

    [hea]
    akai_command = ["/usr/local/bin/akaiKKR", "{input}"]
    env = { "OMP_NUM_THREADS" = "4", "MKL_NUM_THREADS" = "4" }
    timeout_sec = 3600

Example of testing without running AkaiKKR using mock output:

    python optimize_composition.py hea_mapper.toml --mock-output test/refs/test.out

NOTES

Dimension settings:
    When simplex_mode is enabled, base.dimension must be set to number of species - 1.
    Example: For 4-element alloy, dimension=3

    When simplex_mode is disabled, base.dimension is set to number of species.
    Example: For 4-element alloy, dimension=4

Stick-breaking transformation:
    When simplex_mode is enabled, N-1 parameters passed from ODAT-SE are transformed
    by stick-breaking transformation into N concentrations that always sum to 1.0.
    This automatically satisfies composition constraints.

Error handling:
    When a calculation fails, the value specified by error_penalty (default: 1.0e10)
    is returned. This causes the optimization algorithm to avoid failed composition
    points. If error_log is specified, error details are recorded.

SEE ALSO
    README.md
    README_generate_input.md
    hea_mapper.toml
